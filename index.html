<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>×”××¨×ª ××™×§×•× ××’×•×’×œ ×œ-ITM + GovMap</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      padding: 20px;
      background-color: #f9f9f9;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      margin-bottom: 15px;
    }
    #output {
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>×”××¨×ª ×§×™×©×•×¨ ××’×•×’×œ ××¤×•×ª ×œ-ITM + GovMap</h2>
  <label>×”×“×‘×§ ×§×™×©×•×¨:</label>
  <input type="text" id="googleLink" placeholder="https://www.google.com/maps/...">
  <button onclick="convert()">×”××¨</button>
  <div id="output"></div>

  <script>
    function extractLatLngFromURL(url) {
      const atMatch = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
      if (atMatch) {
        return [parseFloat(atMatch[1]), parseFloat(atMatch[2])];
      }
      const dMatch = url.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
      if (dMatch) {
        return [parseFloat(dMatch[1]), parseFloat(dMatch[2])];
      }
      return null;
    }

    function wgs84ToItm(lat, lon) {
      // Parameters from ×¦×‘×™×§×” ×‘×”×˜
      const deg2rad = Math.PI / 180;
      const a = 6378137;
      const e = 0.0818191910428;
      const lon0 = 35.2045169444444;
      const lat0 = 31.7343936111111;
      const k0 = 1.0000067;
      const falseE = 219529.584;
      const falseN = 626907.39;

      const Ï† = lat * deg2rad;
      const Î» = lon * deg2rad;
      const Î»0 = lon0 * deg2rad;
      const Ï†0 = lat0 * deg2rad;

      const Î”Î» = Î» - Î»0;
      const sinÏ† = Math.sin(Ï†);
      const cosÏ† = Math.cos(Ï†);
      const tanÏ† = Math.tan(Ï†);

      const Î½ = a / Math.sqrt(1 - Math.pow(e * sinÏ†, 2));
      const Ï = a * (1 - Math.pow(e, 2)) / Math.pow(1 - Math.pow(e * sinÏ†, 2), 1.5);
      const Î·2 = Î½ / Ï - 1;

      const A = Î”Î» * cosÏ†;
      const T = tanÏ† * tanÏ†;
      const C = Î·2;
      const M = a * (
        (1 - Math.pow(e,2)/4 - 3*Math.pow(e,4)/64 - 5*Math.pow(e,6)/256) * Ï†
        - (3*Math.pow(e,2)/8 + 3*Math.pow(e,4)/32 + 45*Math.pow(e,6)/1024) * Math.sin(2*Ï†)
        + (15*Math.pow(e,4)/256 + 45*Math.pow(e,6)/1024) * Math.sin(4*Ï†)
        - (35*Math.pow(e,6)/3072) * Math.sin(6*Ï†)
      );

      const M0 = a * (
        (1 - Math.pow(e,2)/4 - 3*Math.pow(e,4)/64 - 5*Math.pow(e,6)/256) * Ï†0
        - (3*Math.pow(e,2)/8 + 3*Math.pow(e,4)/32 + 45*Math.pow(e,6)/1024) * Math.sin(2*Ï†0)
        + (15*Math.pow(e,4)/256 + 45*Math.pow(e,6)/1024) * Math.sin(4*Ï†0)
        - (35*Math.pow(e,6)/3072) * Math.sin(6*Ï†0)
      );

      const x = falseE + k0 * Î½ * (
        A + (1 - T + C) * Math.pow(A,3)/6 + (5 - 18*T + T*T + 72*C - 58*Î·2) * Math.pow(A,5)/120
      );

      const y = falseN + k0 * (
        M - M0 + Î½ * tanÏ† * (
          Math.pow(A,2)/2 + (5 - T + 9*C + 4*Math.pow(C,2)) * Math.pow(A,4)/24 +
          (61 - 58*T + T*T + 600*C - 330*Î·2) * Math.pow(A,6)/720
        )
      );

      return [x, y];
    }

    function convert() {
      const input = document.getElementById("googleLink").value.trim();
      const coords = extractLatLngFromURL(input);
      const out = document.getElementById("output");

      if (!coords) {
        out.innerHTML = `<span style="color:red;">âŒ ×œ× ×”×¦×œ×—× ×• ×œ×—×œ×¥ ×§×•××•×¨×“×™× ×˜×•×ª ××”×§×™×©×•×¨</span>`;
        return;
      }

      const [lat, lon] = coords;
      const [itmX, itmY] = wgs84ToItm(lat, lon);

      const govmapUrl = `https://www.govmap.gov.il/?c=${itmX},${itmY}&z=10`;

      out.innerHTML = `
        âœ… <b>×§×•××•×¨×“×™× ×˜×•×ª WGS84:</b><br>
        Latitude: ${lat}<br>
        Longitude: ${lon}<br><br>
        âœ… <b>ITM:</b><br>
        X: ${itmX.toFixed(2)}<br>
        Y: ${itmY.toFixed(2)}<br><br>
        ğŸ”— <a href="${govmapUrl}" target="_blank">×¦×¤×” ×‘××™×§×•× ×‘-GovMap</a>
      `;
    }
  </script>
</body>
</html>
