<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>המרת קישור גוגל ל-ITM</title>
  <style>
    body { font-family: Arial; direction: rtl; text-align: center; margin-top: 50px; }
    input { width: 60%; padding: 10px; font-size: 16px; }
    button { padding: 10px 20px; font-size: 16px; }
    #result { margin-top: 20px; font-size: 18px; }
    a { color: blue; text-decoration: underline; }
  </style>
</head>
<body>

  <h2>המרת קישור גוגל לקואורדינטות מדויקות (ITM)</h2>
  <input type="text" id="googleUrl" placeholder="הדבק קישור גוגל מפות כאן">
  <br><br>
  <button onclick="convert()">המר</button>

  <div id="result"></div>

  <script>
    // הגדרת פרמטרים של מערכת ITM בדיוק כמו של צביקה בהט
    function LatLng2ITM(lat, lon) {
      const deg2rad = Math.PI / 180;
      const rad2deg = 180 / Math.PI;

      const a = 6378137;
      const f = 1 / 298.257222101;
      const b = a * (1 - f);
      const e = Math.sqrt(1 - (b * b) / (a * a));
      const lon0 = 35.20451694444 * deg2rad;
      const k0 = 1.0000067;
      const FE = 219529.584;
      const FN = 626907.39;

      lat *= deg2rad;
      lon *= deg2rad;

      const n = (a - b) / (a + b);
      const A = a / (1 + n) * (1 + n * n / 4 + n ** 4 / 64);

      const t = Math.sinh(Math.atanh(Math.sin(lat)) - (2 * Math.sqrt(n)) / (1 + n) *
        Math.atanh((2 * Math.sqrt(n)) / (1 + n) * Math.sin(lat)));

      const xi = Math.atan(t / Math.cos(lon - lon0));
      const eta = Math.atanh(Math.sin(lon - lon0) / Math.sqrt(1 + t * t));

      let x = k0 * A * xi + FN;
      let y = k0 * A * eta + FE;

      return { x: Math.round(y * 100) / 100, y: Math.round(x * 100) / 100 };
    }

    function extractLatLngFromUrl(url) {
      try {
        // תמיכה בפורמט @LAT,LNG
        let match = url.match(/@([0-9\.\-]+),([0-9\.\-]+)/);
        if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };

        // תמיכה בפורמט !3dLAT!4dLNG
        match = url.match(/!3d([0-9\.\-]+)!4d([0-9\.\-]+)/);
        if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };

        return null;
      } catch (e) {
        return null;
      }
    }

    function convert() {
      const url = document.getElementById("googleUrl").value;
      const coords = extractLatLngFromUrl(url);
      const result = document.getElementById("result");

      if (!coords) {
        result.innerHTML = "לא נמצאו קואורדינטות בקישור.";
        return;
      }

      const itm = LatLng2ITM(coords.lat, coords.lng);

      result.innerHTML = `
        <p><strong>קו רוחב:</strong> ${coords.lat}</p>
        <p><strong>קו אורך:</strong> ${coords.lng}</p>
        <p><strong>ITM X:</strong> ${itm.x}</p>
        <p><strong>ITM Y:</strong> ${itm.y}</p>
        <p><a href="https://www.govmap.gov.il/?c=${itm.x},${itm.y}&z=10" target="_blank">פתיחה ב-GovMap</a></p>
      `;
    }
  </script>
</body>
</html>
