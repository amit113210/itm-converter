<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>המרת קישור מגוגל לקואורדינטות מדויקות (ITM)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: center;
      margin-top: 50px;
    }
    input {
      width: 60%;
      padding: 10px;
      font-size: 1em;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
    }
    .results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>המרת קישור מגוגל לקואורדינטות מדויקות (ITM)</h2>
  <input type="text" id="googleUrl" placeholder="הדבק כאן קישור מגוגל מפות">
  <button onclick="convert()">המר</button>

  <div class="results" id="results"></div>

  <script>
    function extractLatLngFromUrl(url) {
      try {
        let lat, lng;

        const match1 = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (match1) {
          lat = parseFloat(match1[1]);
          lng = parseFloat(match1[2]);
          return { lat, lng };
        }

        const match2 = url.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
        if (match2) {
          lat = parseFloat(match2[1]);
          lng = parseFloat(match2[2]);
          return { lat, lng };
        }

        return null;
      } catch {
        return null;
      }
    }

    async function convert() {
      const url = document.getElementById("googleUrl").value.trim();
      const coords = extractLatLngFromUrl(url);

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (!coords) {
        resultsDiv.innerHTML = "<p style='color:red;'>לא נמצאו קואורדינטות בקישור.</p>";
        return;
      }

      resultsDiv.innerHTML = "<p>מבצע המרה...</p>";

      try {
        const response = await fetch("/convert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(coords),
        });

        const data = await response.json();

        if (!data.itm_x || !data.itm_y) throw new Error("שגיאה בקבלת התוצאה");

        resultsDiv.innerHTML = `
          <p>קו רוחב: ${coords.lat}</p>
          <p>קו אורך: ${coords.lng}</p>
          <p><strong>ITM X:</strong> ${data.itm_x}</p>
          <p><strong>ITM Y:</strong> ${data.itm_y}</p>
          <p><a href="https://www.govmap.gov.il/?x=${data.itm_x}&y=${data.itm_y}&z=10" target="_blank">פתיחה ב-GovMap</a></p>
        `;
      } catch (e) {
        resultsDiv.innerHTML = "<p style='color:red;'>אירעה שגיאה: " + e.message + "</p>";
      }
    }
  </script>
</body>
</html>
